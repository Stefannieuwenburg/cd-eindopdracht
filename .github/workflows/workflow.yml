name: Test and deploy

# Run this workflow whenever something new is pushed.
on: push
jobs:
  test:
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Setup Python
        uses: actions/setup-python@v2
        # Specify some input for this particular action
        with:
          python-version: '3.8.6'
      - name: Install Dependencies
        run: pip install -r requirements.txt
      - name: Run tests with Pytest
        run: pytest

  deploy:
      runs-on: ubuntu-20.04
      needs: run-test 
      if: github.ref == 'refs/heads/main' 
      steps:
        - name: executing remote ssh commands using ssh key
          uses: appleboy/ssh-action@master
          with:
            host: ${{secrets.SSH_HOST}}
            username: ${{secrets.SSH_USERNAME}}
            key: ${{secrets.SSH_KEY}}
            port: ${{secrets.PORT}}
            script: |
              cd ..
              cd home/CD_Stefan
              git pull
              systemctl restart cd